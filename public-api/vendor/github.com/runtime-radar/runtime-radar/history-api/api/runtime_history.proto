syntax = "proto3";

package runtime_history;

import "google/api/annotations.proto";
import "protoc-gen-openapiv2/options/annotations.proto";
import "google/protobuf/timestamp.proto";
import "event-processor/runtime_event.proto";
import "common.proto";

option go_package = "./api";
option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_swagger) = {
  info: {
    title: "History Runtime Events API";
  };
};

service RuntimeHistory {
  rpc Read(ReadRuntimeEventReq) returns (runtime_event.RuntimeEvent) {
    option (google.api.http) = {
      get: "/api/v1/runtime-event/{id}"
    };
  }

  rpc ListRuntimeEventSlice(ListRuntimeEventSliceReq) returns (ListRuntimeEventSliceResp) {
    option (google.api.http) = {
      get: "/api/v1/runtime-event/slice/{direction}"
    };
  }

  rpc FilterRuntimeEventSlice(FilterRuntimeEventSliceReq) returns (ListRuntimeEventSliceResp) {
    option (google.api.http) = {
      post: "/api/v1/runtime-event/by-filter/slice/{direction}"
      body: "*"
    };
  }
}

message ListRuntimeEventSliceReq {
  google.protobuf.Timestamp cursor = 1;
  string direction = 2;
  uint32 slice_size = 3;
}

message RuntimeFilter {
  // event_type represents the type of runtime event registered in the system.
  // Possible values are UNDEF, PROCESS_EXEC, PROCESS_EXIT, PROCESS_KPROBE, PROCESS_TRACEPOINT, PROCESS_LOADER and PROCESS_UPROBE
  repeated string event_type = 1;
  repeated string kprobe_function_name = 2;
  repeated string process_pod_namespace = 3;
  repeated string process_pod_name = 4;
  repeated string node_name = 5;
  repeated string process_pod_container_name = 6;
  repeated string process_pod_container_image_name = 7;
  repeated string process_binary = 8;
  repeated string process_arguments = 9;
  common.Period period = 10;
  optional bool has_threats = 11;

  // Process's execution identifier. This field does not support globs.
  string process_exec_id = 12;
  // Process parent's execution identifier. This field does not support globs.
  string process_parent_exec_id = 13;

  // Identifiers of detectors that have detected threats. This field does not support globs.
  repeated string threats_detectors = 14;
  // Identifiers of worked rules. This field does not support globs.
  repeated string rules = 15;
  optional bool has_incident = 16;
}

message FilterRuntimeEventSliceReq {
  google.protobuf.Timestamp cursor = 1;
  string direction = 2;
  uint32 slice_size = 3;
  RuntimeFilter filter = 4;
}

message ListRuntimeEventSliceResp {
  repeated runtime_event.RuntimeEvent runtime_events = 1;
  google.protobuf.Timestamp left_cursor = 2;
  google.protobuf.Timestamp right_cursor = 3;
}

message ReadRuntimeEventReq {
  string id = 1;
}
