<ng-container *transloco="let tToken; prefix: 'token'">
    <ng-container *ngrxLet="tokens$ as tokens">
        <header class="layout-row layout-align-space-between-center">
            <h1 class="kbq-display-compact token-feature-list-title">
                {{ tToken('Token.ListPage.Header.Title') }}
            </h1>
            <section class="layout-row">
                <cs-cluster-select-component
                        [clusters]="clusters$ | async"
                        [activeClusterHost]="activeClusterHost$ | async"
                        (selectClusterId)="switchCluster($event)"
                        testLocator="token-cluster-select"></cs-cluster-select-component>
                @if (tokens.length) {
                    <button kbq-button
                            kbqStyle="outline"
                            color="theme-fade"
                            class="layout-margin-left-xl"
                            type="button"
                            [disabled]="!permissions[permissionName.TOKENS].has(permissionType.CREATE)"
                            (click)="openCreateSidepanel()"
                            data-testid="token-open-sidepanel-form-button">
                        {{ tToken('Token.ListPage.Button.Create') }}
                    </button>
                }
            </section>
        </header>

        @if (tokens.length && permissions[permissionName.INVALIDATE_TOKENS].has(permissionType.EXECUTE)) {
            <section class="layout-row layout-align-end-center layout-margin-top-xxl">
                <button kbq-button
                        kbqStyle="outline"
                        type="button"
                        (click)="openRevokeModal()"
                        data-testid="token-invalidate-button">
                    <i kbq-icon="kbq-xmark-circle_16"></i>
                    {{ tToken('Token.ListPage.Button.Invalidate') }}
                </button>
            </section>
        }

        @if (tokens.length) {
            <section class="token-feature-list">
                @for (token of tokens; track token.id) {
                    <article class="token-feature-list-card"
                             id="{{ token.id }}"
                             [ngClass]="{ 'expanded': token.access_token }"
                             [attr.data-testid]="token.name">
                        <header class="layout-row layout-wrap layout-align-space-between-center">
                            <h4 class="kbq-title token-feature-list-card-title">{{ token.name }}</h4>
                            <section class="layout-row layout-align-center-center">
                                <kbq-badge
                                        tokenExpirationColor
                                        [expiresAt]="token.expires_at"
                                        [invalidatedAt]="token.invalidated_at"
                                        class="layout-margin-right-xxl">
                                    @if (token.invalidated_at) {
                                        {{ token.invalidated_at | dateFormatter: dateTimeFullFormat | tokenExpirationLabel: token.expires_at: token.invalidated_at }}
                                    } @else if (token.expires_at) {
                                        {{ token.expires_at | dateFormatter: dateTimeFullFormat | tokenExpirationLabel: token.expires_at }}
                                    } @else {
                                        {{ tToken('Token.Pseudo.Label.Indefinitely') }}
                                    }
                                </kbq-badge>
                                <button kbq-button
                                        kbqStyle="transparent"
                                        color="contrast"
                                        type="button"
                                        class="kbq-button-icon"
                                        [disabled]="!permissions[permissionName.TOKENS].has(permissionType.DELETE)"
                                        (click)="openDeleteModal(token.id)"
                                        data-testid="token-delete-button">
                                    <i kbq-icon="kbq-trash_16"></i>
                                </button>
                            </section>
                        </header>

                        @if (token.access_token) {
                            <section class="token-feature-list-card-access">
                                <p class="layout-row layout-align-start-center kbq-text-compact-strong token-feature-list-card-access-alert">
                                    <i kbq-icon="kbq-exclamation-triangle_16" class="token-feature-list-card-access-alert-icon"></i>
                                    <span>{{ tToken('Token.ListPage.Table.Text.AccessToken') }}</span>
                                </p>
                                <cs-clipboard-component [value]="token.access_token"></cs-clipboard-component>
                            </section>
                        }

                        <ul class="layout-row token-feature-list-card-list">
                            <li>
                                <div class="kbq-text-compact cs-text-gray token-feature-list-card-list-label">
                                    {{ tToken('Token.ListPage.Table.Permissions') }}
                                </div>
                                @if (token.permissions[tokenPermissionName.EVENTS]; as eventPermissions) {
                                    @for (item of eventPermissions.actions; track item) {
                                        <span class="cs-separator">{{ item | tokenPermissionType: tokenPermissionName.EVENTS }}</span>
                                    }
                                }
                                @if (token.permissions[tokenPermissionName.RULES]; as rulePermissions) {
                                    @for (item of rulePermissions.actions; track item) {
                                        <span class="cs-separator">{{ item | tokenPermissionType: tokenPermissionName.RULES }}</span>
                                    }
                                }
                            </li>
                        </ul>
                    </article>
                }
            </section>
        } @else {
            <cs-empty-screen-component
                    imageUrl="/assets/koobiq/light/folder-plus_256@2x.png"
                    [title]="tToken('Token.ListPage.SubHeading.EmptyResult')"
                    [description]="tToken('Token.ListPage.Text.EmptyResult')">
                <button kbq-button
                        kbqStyle="outline"
                        color="theme-fade"
                        type="button"
                        [disabled]="!permissions[permissionName.TOKENS].has(permissionType.CREATE)"
                        (click)="openCreateSidepanel()"
                        data-testid="token-open-sidepanel-form-empty-button">
                    {{ tToken('Token.ListPage.Button.Create') }}
                </button>
            </cs-empty-screen-component>
        }
    </ng-container>
</ng-container>
