<ng-container *transloco="let tRuntime; prefix: 'runtime'">
    <button kbq-button
            kbqPopover
            type="button"
            #kbqPopover="kbqPopover"
            [kbqPopoverSize]="tooltipSizes.Large"
            [kbqPopoverContent]="popoverContent"
            [kbqPopoverFooter]="popoverFooter"
            data-testid="runtime-filter-popover-open-button">
        <i kbq-icon="kbq-filter_16"></i>
        <span>{{ tRuntime('Runtime.EventsPage.Filter.Button.Filters') }}</span>
        @if (selectedFilters | runtimeHistoryLabel: selectedFilterLabelLimit; as label) {
            @if (label) {
                <span>: {{ label }}</span>
                <button type="button"
                        class="runtime-feature-filter-popover-reset-icon"
                        (click)="reset(); $event.stopPropagation()"
                        data-testid="runtime-filter-popover-reset-button">
                    <i kbq-icon="kbq-xmark-s_16"></i>
                </button>
            }
        }
    </button>

    <ng-template #popoverContent>
        <form [formGroup]="form" class="kbq-form-vertical runtime-feature-filter-popover">
            <section class="kbq-form__row">
                <kbq-toggle formControlName="hasThreats"
                            data-testid="runtime-filter-popover-has-threats-toggle">
                    {{ tRuntime('Runtime.EventsPage.Filter.FilterPopover.Label.HasThreats') }}
                </kbq-toggle>
            </section>

            @if (form.get('hasThreats')?.value) {
                <section class="kbq-form__row runtime-feature-filter-popover-row">
                    <label for="detectors" class="kbq-form__label">
                        {{ tRuntime('Runtime.EventsPage.Filter.FilterPopover.Label.Detectors') }}
                    </label>
                    <cs-detector-tree-select-component
                            id="detectors"
                            formControlName="detectors"
                            [detectors]="detectors"
                            [runtimeExtras]="selectedFilters.detectors"
                            class="runtime-feature-filter-popover-row-field"
                            testLocator="runtime-filter-popover-detectors-select"></cs-detector-tree-select-component>
                </section>
            }

            <section class="kbq-form__row runtime-feature-filter-popover-row">
                <kbq-toggle formControlName="hasIncident"
                            data-testid="runtime-filter-popover-has-incident-toggle">
                    {{ tRuntime('Runtime.EventsPage.Filter.FilterPopover.Label.HasIncident') }}
                </kbq-toggle>
            </section>

            @if (form.get('hasIncident')?.value) {
                <section class="kbq-form__row runtime-feature-filter-popover-row">
                    <label for="rules" class="kbq-form__label">
                        {{ tRuntime('Runtime.EventsPage.Filter.FilterPopover.Label.Rules') }}
                    </label>
                    <kbq-form-field class="kbq-form__control runtime-feature-filter-popover-row-field">
                        <kbq-select [multiple]="true"
                                    id="rules"
                                    formControlName="rules"
                                    data-testid="runtime-filter-popover-rules-select">
                            @for (node of ruleNodes$ | async; track node.id) {
                                <kbq-option [value]="node.id"
                                            [attr.data-testid]="node.id">
                                    <span [ngClass]="{ 'cs-text-gray runtime-feature-filter-popover-row-field-removed': !!node.isExtra }">
                                        {{ node.name }}
                                    </span>
                                </kbq-option>
                            }
                        </kbq-select>
                    </kbq-form-field>
                </section>
            }

            @for (key of formControlKeys; track key) {
                @if (!hiddenDropdownMenuFilterKey.includes(key)) {
                    <section class="kbq-form__row runtime-feature-filter-popover-row">
                        @if (key !== runtimeEventFilterKey.PERIOD) {
                            <label [for]="key" class="kbq-form__label">
                                {{ tRuntime(runtimeFilterPopoverControlLabelCollection.get(key)!) }}
                                <i kbq-icon="kbq-question-circle_16"
                                   class="cs-help-hover"
                                   kbqTooltip="{{ tRuntime('Runtime.EventsPage.Filter.FilterPopover.Hint') }}"></i>
                            </label>
                        }
                        <div class="layout-row" [ngClass]="{ 'layout-align-start-center': key !== runtimeEventFilterKey.PERIOD }">
                            @switch (key) {
                                @case (runtimeEventFilterKey.TYPE) {
                                    <kbq-form-field class="kbq-form__control">
                                        <kbq-select [id]="key"
                                                    [formControlName]="key"
                                                    data-testid="runtime-filter-popover-type-select">
                                            @for (option of runtimeEventTypeOptions; track option.id) {
                                                <kbq-option [value]="option.id"
                                                            [attr.data-testid]="tRuntime(option.localizationKey)">
                                                    <i class="runtime-feature-filter-popover-row-type-icon"
                                                       runtimeEventTypeIcon
                                                       [type]="option.id"></i>
                                                    {{ tRuntime(option.localizationKey) }}
                                                </kbq-option>
                                            }
                                        </kbq-select>
                                    </kbq-form-field>
                                }
                                @case (runtimeEventFilterKey.PERIOD) {
                                    <cs-runtime-feature-datetime-period-picker-component
                                            class="flex"
                                            id="period"
                                            [formControlName]="key"
                                            testLocator="runtime-filter-popover-period"></cs-runtime-feature-datetime-period-picker-component>
                                }
                                @default {
                                    <kbq-form-field class="kbq-form__control">
                                        <input kbqInput
                                               type="text"
                                               [id]="key"
                                               [formControlName]="key"
                                               placeholder="{{ tRuntime(runtimeFilterPopoverControlPlaceholderCollection.get(key)!) }}"
                                               [attr.data-testid]="'runtime-filter-popover-' + key + '-input'">
                                    </kbq-form-field>
                                }
                            }

                            <button kbq-button
                                    kbqStyle="transparent"
                                    color="contrast"
                                    type="button"
                                    class="kbq-button-icon layout-margin-left-m"
                                    (click)="hideControl(key)"
                                    [attr.data-testid]="'runtime-filter-popover-remove-' + key + '-button'">
                                <i kbq-icon="kbq-trash_16"></i>
                            </button>
                        </div>
                    </section>
                }
            }
        </form>

        @if (hiddenDropdownMenuFilterKey.length) {
            <button kbq-button
                    kbqStyle="transparent"
                    color="contrast"
                    type="button"
                    class="runtime-feature-filter-popover-row"
                    [kbqDropdownTriggerFor]="dropdownMenu"
                    data-testid="runtime-filter-popover-dropdown-menu-button">
                {{ tRuntime('Runtime.EventsPage.Filter.Popover.Button.DropdownMenu') }}
                <i kbq-icon="kbq-chevron-down-s_16"></i>
            </button>
        }
    </ng-template>

    <ng-template #popoverFooter>
        <div class="layout-row layout-align-space-between-center">
            <button kbq-button
                    type="button"
                    [disabled]="(hasChanges$ | async) === false"
                    (click)="reset()"
                    data-testid="runtime-filter-popover-reset-button">
                {{ tRuntime('Runtime.EventsPage.Filter.Popover.Button.Reset') }}
            </button>

            <div class="layout-row layout-align-end-center">
                <button kbq-button
                        kbqStyle="outline"
                        color="theme-fade"
                        type="button"
                        class="layout-margin-right-l"
                        [disabled]="(hasFiltersChanges$ | async) === false"
                        (click)="confirm()"
                        data-testid="runtime-filter-popover-confirm-button">
                    {{ tRuntime('Runtime.EventsPage.Filter.Popover.Button.Confirm') }}
                </button>
                <button kbq-button
                        type="button"
                        (click)="cancel()"
                        data-testid="runtime-filter-popover-cancel-button">
                    {{ tRuntime('Runtime.EventsPage.Filter.Popover.Button.Cancel') }}
                </button>
            </div>
        </div>
    </ng-template>

    <kbq-dropdown #dropdownMenu="kbqDropdown">
        @for (key of hiddenDropdownMenuFilterKey; track key) {
            <button kbq-dropdown-item
                    (click)="showControl(key)"
                    [attr.data-testid]="tRuntime(runtimeFilterPopoverControlLabelCollection.get(key)!)">
                {{ tRuntime(runtimeFilterPopoverControlLabelCollection.get(key)!) }}
            </button>
        }
    </kbq-dropdown>
</ng-container>
