<ng-container *transloco="let tRule; prefix: 'rule'">
    <ng-container *ngrxLet="{
        rules: (rules$ | async),
        loadStatus: (loadStatus$ | async)
    } as rxlet">
        <header class="layout-row layout-align-space-between-center">
            <h1 class="kbq-display-compact rule-feature-list-title">
                {{ tRule('Rule.ListPage.Header.Title') }}
            </h1>
            <section class="layout-row">
                <cs-cluster-select-component
                        [clusters]="clusters$ | async"
                        [activeClusterHost]="activeClusterHost$ | async"
                        (selectClusterId)="switchCluster($event)"
                        testLocator="rule-cluster-select"></cs-cluster-select-component>
                @if (rxlet.rules?.length) {
                    <button kbq-button
                            kbqStyle="outline"
                            color="theme-fade"
                            class="layout-margin-left-xl"
                            type="button"
                            [disabled]="!permissions[permissionName.RULES].has(permissionType.CREATE)"
                            (click)="openCreateSidepanel()"
                            data-testid="rule-open-sidepanel-form-button">
                        {{ tRule('Rule.ListPage.Button.Create') }}
                    </button>
                }
            </section>
        </header>

        @if (rxlet.rules?.length) {
            <cs-rule-feature-panel-filter-component
                    class="rule-feature-list-filter"
                    (filterChange)="changeFilter($event)"></cs-rule-feature-panel-filter-component>
        }

        @if (rxlet.rules | ruleFilter: filters; as rules) {
            @for (rule of rules; track rule.id) {
                <button type="button"
                        class="kbq-text-normal rule-feature-list-card"
                        (click)="openViewSidepanel(rule)"
                        id="{{ rule.id }}"
                        [attr.data-testid]="rule.name">
                    <h4 class="kbq-subheading rule-feature-list-card-title">{{ rule.name }}</h4>
                    <ul class="layout-row rule-feature-list-card-list" *transloco="let tCommon; prefix: 'common'">
                        <li>
                            <div class="kbq-text-compact cs-text-gray rule-feature-list-card-list-label">
                                {{ tRule('Rule.ListPage.Table.Type') }}
                            </div>
                            <span>{{ tCommon(rule.type | ruleTypeLocalization) }}</span>
                        </li>
                        <li>
                            <div class="kbq-text-compact cs-text-gray rule-feature-list-card-list-label">
                                {{ tRule('Rule.ListPage.Table.NotifySeverity') }}
                            </div>
                            <cs-severity-label-component
                                    isWidthAuto
                                    [severity]="rule.rule.notify?.severity"
                                    [verdict]="rule.rule.notify?.verdict"
                                    noneLabelLocalizationKey="Common.Pseudo.Severity.NoneNotifyLabel"></cs-severity-label-component>
                        </li>
                        @if (rule.rule.whitelist.threats.length || rule.rule.whitelist.binaries.length) {
                            <li class="layout-row layout-align-start-center rule-feature-list-card-list-item-whitelist">
                                <span>{{ rule.rule.whitelist.threats.length + rule.rule.whitelist.binaries.length }}</span>
                                <i kbq-icon="kbq-shield-o_16"></i>
                            </li>
                        }
                    </ul>
                    @if (rule.scope.image_names.length || rule.scope.registries.length || rule.scope.namespaces.length) {
                        <ul class="layout-row rule-feature-list-card-list rule-feature-list-card-list--badges">
                            @if (rule.scope.image_names.length) {
                                <li>
                                    <div class="kbq-text-compact cs-text-gray">
                                        {{ tRule('Rule.ListPage.Table.ImageNames') }}
                                    </div>
                                    @for (image of rule.scope.image_names; track image) {
                                        <kbq-badge [badgeColor]="badgeColors.FadeContrast" [outline]="true" class="rule-feature-list-card-list-badge">
                                            <span class="rule-feature-list-card-list-badge-truncate" title="{{ image }}">{{ image }}</span>
                                        </kbq-badge>
                                    }
                                </li>
                            }
                            @if (rule.scope.registries.length) {
                                <li>
                                    <div class="kbq-text-compact cs-text-gray">
                                        {{ tRule('Rule.ListPage.Table.Registries') }}
                                    </div>
                                    @for (registry of rule.scope.registries; track registry) {
                                        <kbq-badge [badgeColor]="badgeColors.FadeContrast" [outline]="true" class="rule-feature-list-card-list-badge">
                                            <span class="rule-feature-list-card-list-badge-truncate" title="{{ registry }}">{{ registry }}</span>
                                        </kbq-badge>
                                    }
                                </li>
                            }
                            @if (rule.scope.namespaces.length) {
                                <li>
                                    <div class="kbq-text-compact cs-text-gray">
                                        {{ tRule('Rule.ListPage.Table.Namespaces') }}
                                    </div>
                                    @for (namespace of rule.scope.namespaces; track namespace) {
                                        <kbq-badge [badgeColor]="badgeColors.FadeContrast" [outline]="true" class="rule-feature-list-card-list-badge">
                                            <span class="rule-feature-list-card-list-badge-truncate" title="{{ namespace }}">{{ namespace }}</span>
                                        </kbq-badge>
                                    }
                                </li>
                            }
                            @if (rule.scope.pods.length) {
                                <li>
                                    <div class="kbq-text-compact cs-text-gray">
                                        {{ tRule('Rule.ListPage.Table.Pods') }}
                                    </div>
                                    @for (pod of rule.scope.pods; track pod) {
                                        <kbq-badge [badgeColor]="badgeColors.FadeContrast" [outline]="true" class="rule-feature-list-card-list-badge">
                                            <span class="rule-feature-list-card-list-badge-truncate" title="{{ pod }}">{{ pod }}</span>
                                        </kbq-badge>
                                    }
                                </li>
                            }
                            @if (rule.scope.containers.length) {
                                <li>
                                    <div class="kbq-text-compact cs-text-gray">
                                        {{ tRule('Rule.ListPage.Table.Containers') }}
                                    </div>
                                    @for (container of rule.scope.containers; track container) {
                                        <kbq-badge [badgeColor]="badgeColors.FadeContrast" [outline]="true" class="rule-feature-list-card-list-badge">
                                            <span class="rule-feature-list-card-list-badge-truncate" title="{{ container }}">{{ container }}</span>
                                        </kbq-badge>
                                    }
                                </li>
                            }
                            @if (rule.scope.nodes.length) {
                                <li>
                                    <div class="kbq-text-compact cs-text-gray">
                                        {{ tRule('Rule.ListPage.Table.Nodes') }}
                                    </div>
                                    @for (node of rule.scope.nodes; track node) {
                                        <kbq-badge [badgeColor]="badgeColors.FadeContrast" [outline]="true" class="rule-feature-list-card-list-badge">
                                            <span class="rule-feature-list-card-list-badge-truncate" title="{{ node }}">{{ node }}</span>
                                        </kbq-badge>
                                    }
                                </li>
                            }
                        </ul>
                    }

                    <div class="rule-feature-list-card-action">
                        <button kbq-button
                                kbqStyle="transparent"
                                color="contrast"
                                type="button"
                                class="kbq-button-icon"
                                [disabled]="!permissions[permissionName.RULES].has(permissionType.UPDATE)"
                                (click)="openEditSidepanel(rule); $event.stopPropagation()"
                                data-testid="rule-update-button">
                            <i kbq-icon="kbq-pencil_16"></i>
                        </button>
                        <button kbq-button
                                kbqStyle="transparent"
                                color="contrast"
                                type="button"
                                class="kbq-button-icon"
                                [disabled]="!permissions[permissionName.RULES].has(permissionType.DELETE)"
                                (click)="openDeleteModal(rule.id); $event.stopPropagation()"
                                data-testid="rule-delete-button">
                            <i kbq-icon="kbq-trash_16"></i>
                        </button>
                    </div>
                </button>
            }

            @if (!rules.length && !!rxlet.rules?.length) {
                <cs-empty-screen-component
                        imageUrl="/assets/koobiq/light/empty_256@2x.png"
                        [title]="tRule('Rule.ListPage.SubHeading.EmptySearch')"
                        [description]="tRule('Rule.ListPage.Text.EmptySearch')">
                </cs-empty-screen-component>
            }
        }

        @if (!rxlet.rules?.length) {
            <cs-empty-screen-component
                    imageUrl="/assets/koobiq/light/folder-plus_256@2x.png"
                    [title]="tRule('Rule.ListPage.SubHeading.EmptyResult')"
                    [description]="tRule('Rule.ListPage.Text.EmptyResult')">
                <button kbq-button
                        kbqStyle="outline"
                        color="theme-fade"
                        type="button"
                        [disabled]="!permissions[permissionName.RULES].has(permissionType.CREATE)"
                        (click)="openCreateSidepanel()"
                        data-testid="rule-open-sidepanel-form-empty-button">
                    {{ tRule('Rule.ListPage.Button.Create') }}
                </button>
            </cs-empty-screen-component>
        }
    </ng-container>
</ng-container>
