<ng-container *transloco="let tRule; prefix: 'rule'">
    <kbq-sidepanel-header [closeable]="true">
        {{ props.isEdit ? tRule('Rule.EditForm.Title.Edit') : tRule('Rule.CreateForm.Title.Create') }}
    </kbq-sidepanel-header>

    <kbq-sidepanel-body class="shared-rule-sidepanel-form"
                        *transloco="let tCommon; prefix: 'common'">
        <form [formGroup]="form" class="kbq-form-vertical" *ngrxLet="notifications$ as notifications">
            <section class="kbq-form__row kbq-form-row_margin">
                <label for="name" class="kbq-form__label">
                    {{ tRule('Rule.CreateForm.Label.Name') }}
                </label>
                <kbq-form-field class="kbq-form__control">
                    <input kbqInput
                           cdkFocusInitial
                           type="text"
                           id="name"
                           formControlName="name"
                           data-testid="rule-name-input">
                    @if (form.get('name')?.invalid) {
                        <kbq-hint color="error">{{ tCommon('Common.Form.Error.Format') }}</kbq-hint>
                    }
                </kbq-form-field>
            </section>

            <section class="kbq-form__row kbq-form-row_margin">
                <label for="nodes" class="kbq-form__label">
                    {{ tRule('Rule.CreateForm.Label.Nodes') }}
                    <i kbq-icon="kbq-question-circle_16"
                       class="cs-help-hover"
                       kbqTooltip="{{ tRule('Rule.CreateForm.Hint.Nodes') }}"></i>
                </label>
                <kbq-form-field class="kbq-form__control"
                                [ngClass]="{ 'ng-invalid': form.get('nodes')?.invalid && form.value.nodes?.length }">
                    <kbq-tag-list #nodesRef data-testid="rule-nodes-tag-list">
                        @for (node of form.value.nodes; track node; let i = $index) {
                            <kbq-tag [value]="node"
                                     (removed)="removeEntity(nodesControl, i)">
                                {{ node }} <i kbq-icon="kbq-xmark-s_16" kbqTagRemove [attr.data-testid]="node"></i>
                            </kbq-tag>
                        }
                        <input id="nodes"
                               [kbqTagInputFor]="nodesRef"
                               [kbqTagInputSeparatorKeyCodes]="separatorKeyCodes"
                               (kbqTagInputTokenEnd)="addEntity($event, nodesControl)"
                               placeholder="{{ !form.value.nodes?.length ? tRule('Rule.CreateForm.Placeholder.Nodes') : '' }}"
                               data-testid="rule-nodes-input">
                    </kbq-tag-list>
                    @if (form.get('nodes')?.invalid && form.value.nodes?.length) {
                        <kbq-hint color="error">{{ tRule('Rule.CreateForm.Error.Nodes') }}</kbq-hint>
                    }
                </kbq-form-field>
            </section>

            <section class="kbq-form__row kbq-form-row_margin">
                <label for="namespaces" class="kbq-form__label">
                    {{ tRule('Rule.CreateForm.Label.Namespaces') }}
                    <i kbq-icon="kbq-question-circle_16"
                       class="cs-help-hover"
                       kbqTooltip="{{ tRule('Rule.CreateForm.Hint.Namespaces') }}"></i>
                </label>
                <kbq-form-field class="kbq-form__control"
                                [ngClass]="{ 'ng-invalid': form.get('namespaces')?.invalid && form.value.namespaces?.length }">
                    <kbq-tag-list #namespacesRef data-testid="rule-namespaces-tag-list">
                        @for (namespace of form.value.namespaces; track namespace; let i = $index) {
                            <kbq-tag [value]="namespace"
                                     (removed)="removeEntity(namespacesControl, i)">
                                {{ namespace }} <i kbq-icon="kbq-xmark-s_16" kbqTagRemove [attr.data-testid]="namespace"></i>
                            </kbq-tag>
                        }
                        <input id="namespaces"
                               [kbqTagInputFor]="namespacesRef"
                               [kbqTagInputSeparatorKeyCodes]="separatorKeyCodes"
                               (kbqTagInputTokenEnd)="addEntity($event, namespacesControl)"
                               placeholder="{{ !form.value.namespaces?.length ? tRule('Rule.CreateForm.Placeholder.Namespaces') : '' }}"
                               data-testid="rule-namespaces-input">
                    </kbq-tag-list>
                    @if (form.get('namespaces')?.invalid && form.value.namespaces?.length) {
                        <kbq-hint color="error">{{ tRule('Rule.CreateForm.Error.Namespaces') }}</kbq-hint>
                    }
                </kbq-form-field>
            </section>

            <section class="kbq-form__row kbq-form-row_margin">
                <label for="pods" class="kbq-form__label">
                    {{ tRule('Rule.CreateForm.Label.Pods') }}
                    <i kbq-icon="kbq-question-circle_16"
                       class="cs-help-hover"
                       kbqTooltip="{{ tRule('Rule.CreateForm.Hint.Pods') }}"></i>
                </label>
                <kbq-form-field class="kbq-form__control"
                                [ngClass]="{ 'ng-invalid': form.get('pods')?.invalid && form.value.pods?.length }">
                    <kbq-tag-list #podsRef data-testid="rule-pods-tag-list">
                        @for (pod of form.value.pods; track pod; let i = $index) {
                            <kbq-tag [value]="pod"
                                     (removed)="removeEntity(podsControl, i)">
                                {{ pod }} <i kbq-icon="kbq-xmark-s_16" kbqTagRemove [attr.data-testid]="pod"></i>
                            </kbq-tag>
                        }
                        <input id="pods"
                               [kbqTagInputFor]="podsRef"
                               [kbqTagInputSeparatorKeyCodes]="separatorKeyCodes"
                               (kbqTagInputTokenEnd)="addEntity($event, podsControl)"
                               placeholder="{{ !form.value.pods?.length ? tRule('Rule.CreateForm.Placeholder.Pods') : '' }}"
                               data-testid="rule-pods-input">
                    </kbq-tag-list>
                    @if (form.get('pods')?.invalid && form.value.pods?.length) {
                        <kbq-hint color="error">{{ tRule('Rule.CreateForm.Error.Pods') }}</kbq-hint>
                    }
                </kbq-form-field>
            </section>

            <section class="kbq-form__row kbq-form-row_margin">
                <label for="containers" class="kbq-form__label">
                    {{ tRule('Rule.CreateForm.Label.Containers') }}
                    <i kbq-icon="kbq-question-circle_16"
                       class="cs-help-hover"
                       kbqTooltip="{{ tRule('Rule.CreateForm.Hint.Containers') }}"></i>
                </label>
                <kbq-form-field class="kbq-form__control"
                                [ngClass]="{ 'ng-invalid': form.get('containers')?.invalid && form.value.containers?.length }">
                    <kbq-tag-list #containersRef data-testid="rule-containers-tag-list">
                        @for (container of form.value.containers; track container; let i = $index) {
                            <kbq-tag [value]="container"
                                     (removed)="removeEntity(containersControl, i)">
                                {{ container }} <i kbq-icon="kbq-xmark-s_16" kbqTagRemove [attr.data-testid]="container"></i>
                            </kbq-tag>
                        }
                        <input id="containers"
                               [kbqTagInputFor]="containersRef"
                               [kbqTagInputSeparatorKeyCodes]="separatorKeyCodes"
                               (kbqTagInputTokenEnd)="addEntity($event, containersControl)"
                               placeholder="{{ !form.value.containers?.length ? tRule('Rule.CreateForm.Placeholder.Containers') : '' }}"
                               data-testid="rule-containers-input">
                    </kbq-tag-list>
                    @if (form.get('containers')?.invalid && form.value.containers?.length) {
                        <kbq-hint color="error">{{ tRule('Rule.CreateForm.Error.Containers') }}</kbq-hint>
                    }
                </kbq-form-field>
            </section>

            <section class="kbq-form__row kbq-form-row_margin">
                <label for="registries" class="kbq-form__label">
                    {{ tRule('Rule.CreateForm.Label.Registries') }}
                    <i kbq-icon="kbq-question-circle_16"
                       class="cs-help-hover"
                       kbqTooltip="{{ tRule('Rule.CreateForm.Hint.Registries') }}"></i>
                </label>
                <kbq-form-field class="kbq-form__control"
                                [ngClass]="{ 'ng-invalid': form.get('registries')?.invalid && form.value.registries?.length }">
                    <kbq-tag-list #registriesRef data-testid="rule-registries-tag-list">
                        @for (registry of form.value.registries; track i; let i = $index) {
                            <kbq-tag [value]="registry"
                                     (removed)="removeEntity(registriesControl, i)">
                                {{ registry }} <i kbq-icon="kbq-xmark-s_16" kbqTagRemove [attr.data-testid]="registry"></i>
                            </kbq-tag>
                        }
                        <input id="registries"
                               [kbqTagInputFor]="registriesRef"
                               [kbqTagInputSeparatorKeyCodes]="separatorKeyCodes"
                               (kbqTagInputTokenEnd)="addEntity($event, registriesControl)"
                               placeholder="{{ !form.value.registries?.length ? tRule('Rule.CreateForm.Placeholder.Registries') : '' }}"
                               data-testid="rule-registries-input">
                    </kbq-tag-list>
                    @if (form.get('registries')?.invalid && form.value.registries?.length) {
                        <kbq-hint color="error">{{ tRule('Rule.CreateForm.Error.Registries') }}</kbq-hint>
                    }
                </kbq-form-field>
            </section>

            <section class="kbq-form__row kbq-form-row_margin">
                <label for="imageNames" class="kbq-form__label">
                    {{ tRule('Rule.CreateForm.Label.ImageNames') }}
                    <i kbq-icon="kbq-question-circle_16"
                       class="cs-help-hover"
                       kbqTooltip="{{ tRule('Rule.CreateForm.Hint.ImageNames') }}"></i>
                </label>
                <kbq-form-field class="kbq-form__control"
                                [ngClass]="{ 'ng-invalid': form.get('imageNames')?.invalid && form.value.imageNames?.length }">
                    <kbq-tag-list #imageNamesRef data-testid="rule-image-names-tag-list">
                        @for (image of form.value.imageNames; track image; let i = $index) {
                            <kbq-tag [value]="image"
                                     (removed)="removeEntity(imageNamesControl, i)">
                                {{ image }} <i kbq-icon="kbq-xmark-s_16" kbqTagRemove [attr.data-testid]="image"></i>
                            </kbq-tag>
                        }
                        <input id="imageNames"
                               [kbqTagInputFor]="imageNamesRef"
                               [kbqTagInputSeparatorKeyCodes]="separatorKeyCodes"
                               (kbqTagInputTokenEnd)="addEntity($event, imageNamesControl)"
                               placeholder="{{ !form.value.imageNames?.length ? tRule('Rule.CreateForm.Placeholder.ImageNames') : '' }}"
                               data-testid="rule-image-names-input">
                    </kbq-tag-list>
                    @if (form.get('imageNames')?.invalid && form.value.imageNames?.length) {
                        <kbq-hint color="error">{{ tRule('Rule.CreateForm.Error.ImageNames') }}</kbq-hint>
                    }
                </kbq-form-field>
            </section>

            <section class="kbq-form__row kbq-form-row_margin">
                <h4 class="kbq-subheading shared-rule-sidepanel-form-subheading">{{ tRule('Rule.CreateForm.SubTitle.Notify') }}</h4>
                <span class="kbq-text-compact cs-text-gray">
                    {{ tRule('Rule.CreateForm.Text.RuntimeSeverityNotifyHint') }}
                </span>
            </section>

            @if (notifications?.length) {
                <section class="kbq-form__row kbq-form-row_margin">
                    <cs-severity-radio-component
                        formControlName="notifySeverity"
                        noneLabelLocalizationKey="Common.Pseudo.Severity.NoneNotifyLabel"
                        id="notifySeverity"
                        testLocator="rule-notify-severity"></cs-severity-radio-component>
                </section>

                <section class="kbq-form__row">
                    <label for="mailIds" class="kbq-form__label">
                        {{ tRule('Rule.CreateForm.Label.Recipients') }}
                    </label>
                    <kbq-form-field class="kbq-form__control">
                        <kbq-select [multiple]="true"
                                    id="mailIds"
                                    formControlName="mailIds"
                                    placeholder="{{ tRule('Rule.CreateForm.Placeholder.Recipients') }}"
                                    data-testid="rule-recipients-select">
                            @for (notification of notifications; track notification.id) {
                                <kbq-option [value]="notification.id"
                                            [attr.data-testid]="notification.name">
                                    {{ notification.name }}
                                </kbq-option>
                            }
                        </kbq-select>
                    </kbq-form-field>
                </section>
            } @else {
                <section class="layout-row layout-align-center-center shared-rule-sidepanel-form-notify-empty">
                    <i kbq-icon="kbq-bell_24"></i>
                    <div class="layout-margin-left-l">
                        <h4 class="kbq-subheading layout-margin-no-top layout-margin-bottom-xs">
                            {{ tRule('Rule.CreateForm.SubHeading.EmptyNotifySeverity') }}
                        </h4>
                        <p class="kbq-text-compact layout-margin-no-top layout-margin-no-bottom">
                            <transloco key="rule.Rule.CreateForm.Text.EmptyNotifySeverity" [params]="{ template: notifyCaptionTemplate }"></transloco>
                            <ng-template #notifyCaptionTemplate>
                                <a kbq-link class="shared-rule-sidepanel-form-notify-empty-link" (click)="goToIntegrationPage()">
                                    <span class="kbq-text-compact" id="cs-transloco-template"></span>
                                </a>
                            </ng-template>
                        </p>
                    </div>
                </section>
            }

            <section class="kbq-form__row layout-margin-top-l">
                <h4 class="kbq-subheading shared-rule-sidepanel-form-subheading">
                    {{ tRule('Rule.CreateForm.WhiteList.SubTitle.Exception') }}
                </h4>
                <span class="kbq-text-compact cs-text-gray">
                    {{ tRule('Rule.CreateForm.WhiteList.Text.Exception.Runtime') }}
                </span>
            </section>

            <section class="kbq-form__row layout-margin-top-l">
                <cs-detector-tree-select-component
                        id="detectors"
                        formControlName="detectors"
                        [detectors]="detectors$ | async"
                        [runtimeExtras]="props.rule?.rule?.whitelist?.threats"
                        testLocator="rule-detector-select"></cs-detector-tree-select-component>
            </section>

            <section class="kbq-form__row layout-margin-top-l">
                <label for="binaries" class="kbq-form__label">
                    {{ tRule('Rule.CreateForm.Label.Binaries') }}
                    <i kbq-icon="kbq-question-circle_16"
                       class="cs-help-hover"
                       kbqTooltip="{{ tRule('Rule.CreateForm.Hint.Binaries') }}"></i>
                </label>
                <kbq-form-field class="kbq-form__control"
                                [ngClass]="{ 'ng-invalid': form.get('binaries')?.invalid && form.value.binaries?.length }">
                    <kbq-tag-list #binariesRef data-testid="rule-binaries-tag-list">
                        @for (binary of form.value.binaries; track binary; let i = $index) {
                            <kbq-tag [value]="binary"
                                     (removed)="removeEntity(binariesControl, i)">
                                {{ binary }} <i kbq-icon="kbq-xmark-s_16" kbqTagRemove [attr.data-testid]="binary"></i>
                            </kbq-tag>
                        }
                        <input id="binaries"
                               [kbqTagInputFor]="binariesRef"
                               [kbqTagInputSeparatorKeyCodes]="separatorKeyCodes"
                               (kbqTagInputTokenEnd)="addEntity($event, binariesControl)"
                               placeholder="{{ !form.value.binaries?.length ? tRule('Rule.CreateForm.Placeholder.Binaries') : '' }}"
                               data-testid="rule-binaries-input">
                    </kbq-tag-list>
                    @if (form.get('binaries')?.invalid && form.value.binaries?.length) {
                        <kbq-hint color="error">{{ tRule('Rule.CreateForm.Error.Binaries') }}</kbq-hint>
                    }
                </kbq-form-field>
            </section>
        </form>
    </kbq-sidepanel-body>

    <kbq-sidepanel-footer>
        <kbq-sidepanel-actions align="left">
            <button kbq-button
                    kbqStyle="outline"
                    color="theme-fade"
                    type="button"
                    [disabled]="(isFormValid$ | async) === false"
                    (click)="confirm()"
                    data-testid="rule-confirm-button">
                {{ props.isEdit ? tRule('Rule.EditForm.Button.Confirm') : tRule('Rule.CreateForm.Button.Confirm') }}
            </button>
        </kbq-sidepanel-actions>
        <kbq-sidepanel-actions align="right">
            <button kbq-button
                    type="button"
                    (click)="cancel()"
                    data-testid="rule-cancel-button">
                {{ tRule('Rule.CreateForm.Button.Cancel') }}
            </button>
        </kbq-sidepanel-actions>
    </kbq-sidepanel-footer>
</ng-container>
